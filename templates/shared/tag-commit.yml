parameters:
  githubPat: ""

steps:
- powershell: |
    function Render-Body { $input | foreach{@{value=$_}} | Format-Table -Property @{Expression={" "}},value -HideTableHeader -wrap}

    $version = echo $(version) # TODO don't know why $(version) can't be used without echo

    if(-not($version))
    {
      "No new version, nothing to tag."
    }

    # Create new tag
    "Tagging commit:"      
    $commitAuthorName = git show --pretty="%an" --quiet
    "    Commit author name: " + $commitAuthorName
    git config user.name $commitAuthorName
    
    $commitAuthorEmail = git show --pretty="%ae" --quiet
    "    Commit author email: " + $commitAuthorEmail
    git config user.email $commitAuthorEmail

    git tag -a $version -m "Azure build ID: $env:BUILDID"

    # Push to Github
    $uri = $env:BUILD_REPOSITORY_URI -replace "github.com", "$env:GITHUB_PAT@github.com"
    "`nPushing tag to Github:"
    git push -u $uri $version -q | Render-Body
    "    Tag $version pushed to Github."
  env: 
    GITHUB_PAT: ${{parameters.githubPat}}