parameters:
  dotnetSdkVersion: ""
  dotnetRuntimeVersions: []
  outOfProcessTestDependencies: []
  outOfProcessBuildDependencies: []
  buildConfiguration: "Release"
  codecovKey: ""
  runCodeCoverage: true
  runTests: true
  cacheYarnPackages: false

steps:
- task: Cache@2
  inputs:
    key: 'nuget | "$(Agent.OS)" | **/packages.lock.json'
    restoreKeys: |
       nuget | "$(Agent.OS)"
       nuget
    path: $(NUGET_PACKAGES)
  displayName: Cache NuGet packages
- ${{if eq(parameters.cacheYarnPackages, 'true')}}:
  - task: Cache@2
    inputs:
      key: 'yarn | "$(Agent.OS)" | **/yarn.lock'
      restoreKeys: |
        yarn | "$(Agent.OS)"
        yarn
      path: $(YARN_CACHE_FOLDER)
    displayName: Cache Yarn packages
- template: "install-dotnet.yml"
  parameters:
    dotnetSdkVersion: ${{parameters.dotnetSdkVersion}}
    dotnetRuntimeVersions: ${{parameters.dotnetRuntimeVersions}}
- script: "dotnet restore"
  displayName: "Restore"
- ${{if containsValue(parameters.outOfProcessBuildDependencies, 'nodejs')}}:
  - template: "../shared/install-nodejs.yml"
- script: "dotnet build --no-restore --configuration ${{parameters.buildConfiguration}}"
  displayName: "Build"
- ${{if eq(parameters.runTests, 'true')}}:
  - ${{if containsValue(parameters.outOfProcessTestDependencies, 'ffmpeg')}}:
    - template: "../shared/install-ffmpeg.yml"
  - script: "dotnet test -v n --no-restore --no-build --configuration ${{parameters.buildConfiguration}} -p:CollectCoverage=${{parameters.runCodeCoverage}} -p:CoverletOutputFormat=cobertura"
    displayName: "Test"
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      DOTNET_CLI_TELEMETRY_OPTOUT: true
  - ${{if eq(parameters.runCodeCoverage, 'true')}}:
    - template: "publish-code-coverage-reports.yml"
      parameters:
        codecovKey: ${{parameters.codecovKey}}
        runCodeCoverage: ${{parameters.runCodeCoverage}}